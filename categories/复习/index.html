<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hexo</title>
  <meta name="keywords" content="">
  <meta name="description" content="Hexo">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="接口列表   接口 说明    &#x2F;p&#x2F;global&#x2F;strategy 请求全局策略   &#x2F;p&#x2F;user&#x2F;userLogin 用户登录接口        ##错误码列表|  错误码  | 说明 ||—— |—– ||   0   | 正确 ||   1   | 错误 ||   2   | 参数错误| 接口详情 全局策略 接口地址：&#x2F;p&#x2F;global&#x2F;strategy  返回格式：Json  请求方式">
<meta property="og:type" content="article">
<meta property="og:title" content="API文档">
<meta property="og:url" content="http://example.com/2017/03/23/%E8%A7%86%E9%A2%91/Api/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="接口列表   接口 说明    &#x2F;p&#x2F;global&#x2F;strategy 请求全局策略   &#x2F;p&#x2F;user&#x2F;userLogin 用户登录接口        ##错误码列表|  错误码  | 说明 ||—— |—– ||   0   | 正确 ||   1   | 错误 ||   2   | 参数错误| 接口详情 全局策略 接口地址：&#x2F;p&#x2F;global&#x2F;strategy  返回格式：Json  请求方式">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-23T07:13:47.000Z">
<meta property="article:modified_time" content="2022-06-15T14:30:16.896Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="hexo">
<meta property="article:tag" content="3-hexo">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 5.4.2"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav mobile">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>John Doe</span>
</div>

<div class="icon">
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/yelog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="facebook"
               href="https://www.facebook.com/faker.tops"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-facebook"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
            <a title="instagram"
               href="https://www.facebook.com/faker.tops"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-instagram"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="reddit"
               href="https://www.reddit.com/user/yelog/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-reddit"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="weibo"
               href="http://weibo.com/u/2307534817"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-weibo"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="jianshu"
               href="https://www.jianshu.com/u/ff56736de7cf"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-jianshu"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="zhihu"
               href="https://www.zhihu.com/people/jaytp/activities"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-zhihu"></use>
                    </svg>
                
            </a>
        
    
        
    
        
            <a title="oschina"
               href="https://my.oschina.net/yelog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-oschina"></use>
                    </svg>
                
            </a>
        
    
        
    
        
            <a title="email"
               href="mailto:jaytp@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=872336115&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="kugou"
               href="https://www.kugou.com/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-kugou"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="neteasemusic"
               href="https://music.163.com/#/user/home?id=88151013"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-neteasemusic"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(7)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="工具">
                        
                        工具
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="数据库">
                        
                        数据库
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="复习">
                        
                        复习
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="其他">
                        
                        其他
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">About</a>
        
        <a style="width: 50%"
                
                                           class="friends">Friends</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="7">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>3-hexo</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>hexo</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="All 其他 "
           href="/2017/03/23/%E8%A7%86%E9%A2%91/Api/"
           data-tag="hexo,3-hexo"
           data-author="" >
            <span class="post-title" title="API文档">API文档</span>
            <span class="post-date" title="2017-03-23 15:13:47">2017/03/23</span>
        </a>
        
        <a  class="All 复习 "
           href="/2017/03/23/%E5%A4%8D%E4%B9%A0/%E5%A4%8D%E4%B9%A0/"
           data-tag="hexo,3-hexo"
           data-author="" >
            <span class="post-title" title="知识点复习">知识点复习</span>
            <span class="post-date" title="2017-03-23 15:13:47">2017/03/23</span>
        </a>
        
        <a  class="All 其他 "
           href="/2017/03/23/%E8%A7%86%E9%A2%91/%E8%A7%86%E9%A2%91/"
           data-tag="hexo,3-hexo"
           data-author="" >
            <span class="post-title" title="视频小demo">视频小demo</span>
            <span class="post-date" title="2017-03-23 15:13:47">2017/03/23</span>
        </a>
        
        <a  class="All 工具 "
           href="/2017/03/23/%E5%B7%A5%E5%85%B7/git%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"
           data-tag="hexo,3-hexo"
           data-author="" >
            <span class="post-title" title="git常见问题">git常见问题</span>
            <span class="post-date" title="2017-03-23 15:13:47">2017/03/23</span>
        </a>
        
        <a  class="All 工具 "
           href="/2017/03/23/%E5%B7%A5%E5%85%B7/hexo%E6%95%99%E7%A8%8B/"
           data-tag="hexo,3-hexo"
           data-author="" >
            <span class="post-title" title="hexo博客搭建教程">hexo博客搭建教程</span>
            <span class="post-date" title="2017-03-23 15:13:47">2017/03/23</span>
        </a>
        
        <a  class="All 复习 "
           href="/2017/03/23/%E5%A4%8D%E4%B9%A0/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"
           data-tag="hexo,3-hexo"
           data-author="" >
            <span class="post-title" title="知识图谱">知识图谱</span>
            <span class="post-date" title="2017-03-23 15:13:47">2017/03/23</span>
        </a>
        
        <a  class="All 数据库 "
           href="/2017/03/23/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%94%81/"
           data-tag="hexo,3-hexo"
           data-author="" >
            <span class="post-title" title="数据库锁">数据库锁</span>
            <span class="post-date" title="2017-03-23 15:13:47">2017/03/23</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post" class="index">
    <div class="pjax">
        <article class="index">
            <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96"><span class="toc-text">1. 数据库优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-JVM%E8%BF%99%E5%9D%97GC%E7%9A%84%E7%90%86%E8%A7%A3"><span class="toc-text">2. JVM这块GC的理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8F%8A%E8%AE%A4%E8%AF%86"><span class="toc-text">3. 分布式锁的使用及认识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Zookeer%E7%9A%84Leader%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6"><span class="toc-text">4. Zookeer的Leader选举机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-text">4. 自定义负载均衡算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95-1"><span class="toc-text">4. 自定义负载均衡算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9B%B8%E5%85%B3"><span class="toc-text">5. 线程池相关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-SpringBoot%E6%B3%A8%E8%A7%A3"><span class="toc-text">6.SpringBoot注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Async%E6%B3%A8%E8%A7%A3"><span class="toc-text">6.1 @Async注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-EventListener%E6%B3%A8%E8%A7%A3"><span class="toc-text">6.2 @EventListener注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-Order%E6%B3%A8%E8%A7%A3"><span class="toc-text">6.3 @Order注解</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
            <h2 id="1-数据库优化"><a href="#1-数据库优化" class="headerlink" title="1. 数据库优化"></a>1. 数据库优化</h2><ol>
<li>字段设计和使用规范上（结合业务）<ol>
<li>按业务的实际来确定字段的长度和类型</li>
<li>枚举或者Bool类型使用tinyint</li>
<li>数量统计值之类的使用integer</li>
<li>订单号使用bigint</li>
<li>金额使用decimal不能使用double, 因为会出现精度问题</li>
<li>日期类型建议使用datetime，不使用时间戳</li>
<li>正确使用大字段，text和blob, 尽量不用，会导致库表体积过大</li>
</ol>
</li>
<li>分库分表<ol>
<li>分库：（各个业务、子产品分库，一些经常被访问的业务库，不会影响到其他的子产品）</li>
<li>分表：（单表体积过大时（单表数据超过500W），考虑水平分表，会带来主键ID、跨表查询问题、存储问题（取模落到那一个库）、扩容问题（需要重新取模运算，移动数据））<ol>
<li>用户id不是自增主键id, 而是根据创建日期、时间戳、服务器标识</li>
<li>UUId % 数据库数量获取值，决定放到哪个库中（空间换时间）</li>
<li>当数据过大时需要扩容数据库，这时会涉及到uuid的取模和重排问题，也就是数据迁移问题</li>
</ol>
</li>
</ol>
</li>
<li>SQL使用上注意点<ol>
<li>禁止反向查询，比如 !=、&lt;&gt;、NOT、!&lt;、!&gt;、not like、not in等</li>
<li>查询避免隐式转换，会导致全表扫面，比如select where，where条件中的字段类型是varchar，但你用int类型等</li>
<li>查询where条件不使用函数和表达式</li>
<li>模糊查询时，避免使用%开头</li>
<li>大表查询时，避免使用join连表查询</li>
<li>大表查询时，避免使用子查询（会产生临时表，占用内存和cpu）</li>
<li>业务场景需要根据多个字段组合查询时，需要的字段创建联合索引</li>
</ol>
</li>
<li>数据库主从复制</li>
<li>读写分离</li>
</ol>
<p> a. 使用Mysql-Proxy来提升数据库的并发负载能力</p>
<ol start="6">
<li>库表水平和垂直扩容</li>
<li>技术落地<ol>
<li>解决高并发读请求<ol>
<li>通过mysql binglog主从架构方案做的分组</li>
<li>主节点主要用于写入，从节点用于查询</li>
</ol>
</li>
<li>解决单表数据过大的场景<ol>
<li>通过mysql shading 集群方案做的分库切片</li>
<li>分组+切片的方案，来解决高并发数据量过大问题</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="2-JVM这块GC的理解"><a href="#2-JVM这块GC的理解" class="headerlink" title="2. JVM这块GC的理解"></a>2. JVM这块GC的理解</h2><ol>
<li>gc就是对jvm中内存中的垃圾进行收集和销毁</li>
<li>收集的算法有哪些<ol>
<li>标记清除算法<ol>
<li>标记出所有要被回收大的对象</li>
<li>标记完统一回收所有被标记的对象</li>
<li>特点：标记和清楚的效率都不高，空间不连续问题，会产生大量内存碎片（当大对象无法找打连续内存存储的时候，就得触发一次GC）</li>
</ol>
</li>
<li>复制算法<ol>
<li>把内存容量分为大小相等的两个部分</li>
<li>每次使用其中的一块，在第一次内存使用完，将还活着的对象复制到另一块中，将已使用的空间一次性清理掉</li>
<li>特点：实现简单、效率高，但是内存缩小一半，代价太大</li>
</ol>
</li>
<li>标记整理算法<ol>
<li>标记过程和清理算法一样，但后续是将所有存活的对象都向一段移动，直接清理掉边界以外的内存</li>
</ol>
</li>
<li>分代收集算法<ol>
<li>java堆分为新生代、老年代、永久代</li>
<li>新生代垃圾回收率高，选用复制算法</li>
<li>老年代存活率高，使用标记清除或者是标记清理算法来回收</li>
</ol>
</li>
<li>分代收集算法的运作流程是什么？<ol>
<li>首先java堆分为新生代、老年代、永久代</li>
<li>永久代，jvm处于方法区的永久代，他是用来存储class类，常量，方法描述等，对永久代的回收主要包括废弃常量和无用的类</li>
<li>新生代分为三个区域，一个Eden区和两个survivor区，survivor区有两块（from区、to区），他们的默认比例是8:1:1 (是可以修改的)，在发生一次Minor GC后，from区会和to区互换，在发生Minor GC时，Eden区和Surival from区会把之前一些存活的对象复制到to区，并清理内存，to区会把一些存活足够久的对象移动至老年代，当对象在survivor区躲过一次GC 后，其年龄就会+1，默认情况下年龄达到15的对象就会被移动到老年代中</li>
<li>老年代里存放的对象都是活的比较久的、大小较大的对象，因此老年代使用标记整理算法，当老年代容量满时，就会触发一次Major GC(full GC), full GC的代价比较大，会回收老年代和年轻代中不再被使用的对象</li>
</ol>
</li>
<li>老年代中CMS的收集器的原理<ol>
<li>CMS最主要的目标就是获取最短垃圾回收停顿时间</li>
<li>和其他老年代使用的标记整理算法不同，他使用的是多线程的标记-清除算法</li>
<li>大概可以分为六个部分</li>
<li>第一部分：初始标记，标记老年代中所有的GC Roots对象，作为引用计数的对象（计数年轻代中活着的对象引用到老年代的对象）</li>
<li>第二部分：并发标记，该阶段GC线程和应用线程并发执行，会遍历初始标记阶段标记出的存活对象，然后继续递归标记这些对象的可达对象</li>
<li>第三部分：预清理阶段，由于在并发标记阶段，应用线程和GC线程是并发执行的， 因此可能会产生新的对象或者对象关系发生变化，该阶段会把对象所在的card标识为dety，后续只扫描这些dety card对象，避免扫描整个老年代</li>
<li>第四部分：可终止的预处理，处理from和To区的对象，标记可达的老年代对象，和上一个阶段一样，也是扫描dety card对象</li>
<li>第五部分：重新标记，暂停所有用户线程，重新扫描堆中的对象，进行可达性分析，标记活着的对象（有了上面的基础，这个阶段的工作量被大大的减轻，停顿的时间因此也会减少，这个阶段也是使用的多线程）</li>
<li>第六部分：并发清理，通过以上5个阶段的标记，老年代所有存活的对象已经被标记，并且现在要通过垃圾收集器采用清理的方式，回收那些不能用的对象（由于CMS并发清理阶段的用户线程还运行着，伴随程序运行，自然就还有新的垃圾不断产生，这一部分垃圾出现在标记过程之后，cms无法在当此收集中处理掉他们，只能等到下一次GC再清理掉）</li>
</ol>
</li>
<li>无效的内存销毁的条件是什么？<ol>
<li>JVM通过引用计数或者可达性分析算法来判断对象是否应该回收</li>
<li>一般我们是通过可达性分析来处理的，即使被标记一次GC Roots不可达，会被加入到F-Queue的队列中，当第二次再被标记时会被回收</li>
<li>程序员自己调用GC</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="3-分布式锁的使用及认识"><a href="#3-分布式锁的使用及认识" class="headerlink" title="3. 分布式锁的使用及认识"></a>3. 分布式锁的使用及认识</h2><ol>
<li><p>使用分布式锁的业务</p>
</li>
<li><p>分布式锁是解决共享资源的问题的，你们是怎么解决这种问题的</p>
<pre><code>思路：每个节点通过set key的方式，来做竞争锁，达到有序的消费资源
</code></pre>
<ol>
<li>第一步首先利用redis的缓存的性质，在Redis中设置key-value的形式，key是锁的名称，然后多个线程去竞争这个锁，竞争成功的话，将value设为客户端唯一标识（一般是线程id）</li>
<li>第二步竞争到锁的客户端要做两件事，一个是设置锁的有效期（TTL）,目标就是防止死锁，需要根据业务的需要，不断的做压力测试来决定TTL的有效期的合理时间，第二个是分配给客户端的唯一标识，目的是保证只有只有锁的人才能解锁或可重入</li>
<li>第三步的话，写代码逻辑，正常的访问共享资源</li>
<li>第四步就是释放锁，释放锁有两种情况，第一种是有效期结束后自带释放锁，第二种是先根据唯一标识，判断自己是否有释放锁的权限</li>
</ol>
</li>
<li><p>分布式锁有哪些特征</p>
<ol>
<li>互斥性(在任意时刻只能有一个客户端可以获取锁)</li>
<li>防死锁(假设一个持有锁的客户端崩溃了，没有释放锁，那么别的客户端就永远无法获得锁，就会造成死锁，所以要保证客户端一定会释放锁，ttl机制可以解决死锁问题)</li>
<li>可重入（当一个获取锁的客户端，可以再次获取这个对象上的锁）</li>
<li>唯一性，线程只能给自己解锁（持有锁的线程去解锁，谁加的锁有谁来释放锁）</li>
</ol>
</li>
<li><p>总结</p>
</li>
</ol>
<h2 id="4-Zookeer的Leader选举机制"><a href="#4-Zookeer的Leader选举机制" class="headerlink" title="4. Zookeer的Leader选举机制"></a>4. Zookeer的Leader选举机制</h2><ol>
<li>是基于Paxos算法实现的，解决分布式系统中就某个协议达成一致的方案</li>
<li>Leader的选举分为两种情况<ol>
<li>集群启动时期</li>
<li>集群运行时期<ol>
<li>当leader崩溃或者leader失去大多数的follower的时候，zk会进入恢复模式，处于恢复模式时是不对外提供服务的，直到有一个新的leader产生，让所有的server都恢复到一个正确状态</li>
<li>当leader挂了，余下的非Observer服务器都会将自己的服务器状态变更为LOOKING，然后进入leader选举流程，每个server会发出一个投票，在这个过程中，需要生成投票信息（myid、ZXID），　</li>
<li>myid是当前集群定义的id</li>
<li>zxid是事务id，用来投票的，假设server1的zxid为123，server3的zxid是122，在新一轮的投票中server1和server3都会投票给自己，即产生两组投票（myid, zxid）（1，123）（3, 122）, 各自将自己的投票信息发给集群中的所有机器</li>
<li>处理投票</li>
<li>统计投票，如果最后统计结果是（1，123）（3，122），因为123&gt;122， 所以server1会成为leader(根据权重比选举leader)</li>
<li>成为leader之后就会改变服务器的状态，server1的节点变成leader，其他的变成fllower</li>
</ol>
</li>
</ol>
</li>
<li></li>
</ol>
<h2 id="4-自定义负载均衡算法"><a href="#4-自定义负载均衡算法" class="headerlink" title="4. 自定义负载均衡算法"></a>4. 自定义负载均衡算法</h2><p>工作中遇到的难题</p>
<ol>
<li>偶尔遇到GC卡顿、线程的停顿的情况<ol>
<li>CPU分析，通过top命令和jstack [pid]的堆栈信息来进行分析<ol>
<li>线程中有无限空循环</li>
<li>无阻塞</li>
<li>正则匹配（会导致无限的向上匹配，也会导致cpu被沾满）</li>
</ol>
</li>
<li>单纯的计算发生了频繁的gc<ol>
<li>对象这块的使用上问题</li>
<li>流程上使用大对象过多</li>
</ol>
</li>
<li>多线程的上下文切换</li>
</ol>
</li>
<li>内存这块遇到问题<ol>
<li>堆内内存（OOM问题）</li>
<li>堆外内存（通过sysstat套件）（JNI、Deflater/Infalter、DirectByteBuffer使用的问题）</li>
</ol>
</li>
<li>IO阻塞，导致逻辑处理不顺畅<ol>
<li>文件IO</li>
<li>网络IO（请求链路这块）</li>
</ol>
</li>
</ol>
<h2 id="4-自定义负载均衡算法-1"><a href="#4-自定义负载均衡算法-1" class="headerlink" title="4. 自定义负载均衡算法"></a>4. 自定义负载均衡算法</h2><h2 id="5-线程池相关"><a href="#5-线程池相关" class="headerlink" title="5. 线程池相关"></a>5. 线程池相关</h2><ol>
<li><p>SimpleAsyncTaskExecutor，该线程池默认来一个任务创建一个线程</p>
</li>
<li><p>SimpleAsyncTaskExecutor提供了限流机制，通过concurrencyLimit属性来控制开关，当concurrencyLimit&gt;=0时开启限流机制，默认关闭限流机制即concurrencyLimit=-1，当关闭情况下，会不断创建新的线程来处理任务，核心代码如下：</p>
<pre><code class="bash">public void execute(Runnable task, long startTimeout) {
Assert.notNull(task, &quot;Runnable must not be null&quot;);
Runnable taskToUse = (this.taskDecorator != null ? this.taskDecorator.decorate(task) : task);
//判断是否开启限流机制
if (isThrottleActive() &amp;&amp; startTimeout &gt; TIMEOUT_IMMEDIATE) {
   //执行前置操作，进行限流
   this.concurrencyThrottle.beforeAccess();
   //执行完线程任务，会执行后置操作concurrencyThrottle.afterAccess()，配合进行限流
   doExecute(new ConcurrencyThrottlingRunnable(taskToUse));
}
else {
   doExecute(taskToUse);
}
}
</code></pre>
</li>
<li><p>SimpleAsyncTaskExecutor限流实现<br>首先任务进来，会循环判断当前执行线程数是否超过concurrencyLimit，如果超了，则当前线程调用wait方法，释放monitor对象锁，进入等待</p>
</li>
</ol>
<p>作者：有点意思_yxwn<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e53ca1b804f2">https://www.jianshu.com/p/e53ca1b804f2</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<h2 id="6-SpringBoot注解"><a href="#6-SpringBoot注解" class="headerlink" title="6.SpringBoot注解"></a>6.SpringBoot注解</h2><h3 id="6-1-Async注解"><a href="#6-1-Async注解" class="headerlink" title="6.1 @Async注解"></a>6.1 @Async注解</h3><ol>
<li>默认线程池name=taskExecutor (可使用自定义线程池覆盖Bean或者@Async(“ThreadPoolBean”))</li>
<li>@Async默认异步配置使用的是SimpleAsyncTaskExecutor，该线程池默认来一个任务创建一个线程，在压测情况下，若是有大量写库请求进入日志写库服务，这时就会不断创建大量线程，极有可能压爆服务器内存。</li>
<li>主要使用场景就是使用线程池异步执行方法（注解可加在类或者方法上）</li>
</ol>
<h3 id="6-2-EventListener注解"><a href="#6-2-EventListener注解" class="headerlink" title="6.2 @EventListener注解"></a>6.2 @EventListener注解</h3><ol>
<li>借助Spring 的事件监听器，完成事件的注册监听功能</li>
<li>通过实现ApplicationContextAware接口，借助Spring 容器来完成事件功能</li>
<li>事件分两种，自定义事件，Spring事件</li>
</ol>
<p>自定义事件：MyEvent<br>Spring事件：RecordCallbackEvent extends ApplicationEvent<br>区别：Spring事件可以打印出更全的事件链信息</p>
<pre><code class="bash">@Component
public class MyListener {

    @Async
    @EventListener
    public void recordCallbackEvent(MyEvent event) {
        System.out.println(&quot;==========监听到自定义事件:=======&quot; + event);
    }

    @Async
    @EventListener
    public void recordEvent(SpringEvent event) {
        System.out.println(&quot;==========监听到SpringEvent事件:=======&quot; + event);
    }
}

==========监听到SpringEvent事件:=======com.example.demo.service.event.SpringEvent[source=com.example.demo.service.event.MyService@7159a5cd]
==========监听到自定义事件:=======com.example.demo.service.event.MyEvent@5476207
</code></pre>
<p>核心代码：</p>
<pre><code class="bash">/**
 * @author madeke
 */
public class AggregateRoot {
    private ApplicationContext context = SpringContextHolder.getApplicationContext();

    public void publish(ApplicationEvent event) {
        this.context.publishEvent(event);
    }

    @Async
    public void publishAsync(ApplicationEvent event) {
        this.context.publishEvent(event);
    }

    @Async
    public void publishObjectAsync(Object event) {
        this.context.publishEvent(event);
    }
}
</code></pre>
<p> 发送事件：</p>
<pre><code class="bash">@Component
public class MyService extends AggregateRoot {

    public void test(){
        publishCallbackEventSuccess();
    }

    private void publishCallbackEventSuccess() {
        MyEvent myEvent = new MyEvent();
        myEvent.fill(&quot;aa&quot;);
        myEvent.publishObjectAsync(myEvent);
    }

}
</code></pre>
<p>监听事件：</p>
<pre><code class="bash">@Component
public class MyListener {

    @Async
    @EventListener
    public void recordCallbackEvent(MyEvent event) {
        System.out.println(&quot;==========监听到事件=======&quot;);
        System.out.println(&quot;==========事件参数:=======&quot; + event);
    }
}
</code></pre>
<h3 id="6-3-Order注解"><a href="#6-3-Order注解" class="headerlink" title="6.3 @Order注解"></a>6.3 @Order注解</h3><p>是用来控制bean的执行顺序的而并非加载顺序。</p>

        </article>
        
        <p>
            <a  class="dashang" onclick="dashangToggle()">赏</a>
        </p>
        
        
    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2016-2020 Yelog
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
</div>
<div class="full-toc">
    <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
